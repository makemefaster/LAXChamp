<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 1. GET EVENT ID FROM URL
    const params = new URLSearchParams(window.location.search);
    const eventId = params.get('event');

    if(!eventId) {
        alert("No Event ID provided. Please access via Director Portal.");
        window.location.href = "director.html";
    }

    const sportPresets = {
        lacrosse: { duration: 60, break: 10, periods: 4 },
        basketball: { duration: 40, break: 15, periods: 4 },
        soccer: { duration: 90, break: 15, periods: 2 },
        rugby: { duration: 14, break: 2, periods: 2 },
        hockey: { duration: 60, break: 15, periods: 3 },
        volleyball: { duration: 60, break: 10, periods: 3 },
        netball: { duration: 60, break: 5, periods: 4 },
        baseball: { duration: 120, break: 20, periods: 1 }
    };

    let tournamentData = { sport: '', settings: {}, divisions: [] };

    window.selectSport = (sport) => {
        document.querySelectorAll('.sport-card').forEach(el => el.classList.remove('selected'));
        event.target.classList.add('selected');
        tournamentData.sport = sport;
        
        const s = sportPresets[sport] || { duration: 30, break: 5 };
        document.getElementById('gameDuration').value = s.duration;
        document.getElementById('breakDuration').value = s.break;
        setTimeout(() => changeStep(2), 300);
    };

    window.changeStep = (stepNum) => {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${stepNum}`).classList.add('active');
    };

    window.addDivision = () => {
        const name = document.getElementById('divNameInput').value;
        const teamsStr = document.getElementById('teamsInput').value;
        if(!name || !teamsStr) return alert("Fill info");
        
        const teams = teamsStr.split(',').map(t => t.trim());
        tournamentData.divisions.push({ name, teams });
        
        const divEl = document.createElement('div');
        divEl.className = 'division-item';
        divEl.innerHTML = `<strong>${name}</strong>: ${teams.length} teams`;
        document.getElementById('divisionList').appendChild(divEl);
        
        document.getElementById('divNameInput').value = '';
        document.getElementById('teamsInput').value = '';
    };

    window.finishSetup = () => {
        tournamentData.settings = {
            duration: parseInt(document.getElementById('gameDuration').value),
            breakTime: parseInt(document.getElementById('breakDuration').value),
            fields: parseInt(document.getElementById('fieldCount').value)
        };

        // WRITE TO SPECIFIC EVENT NODE
        const scheduleRef = ref(db, `tournaments/${eventId}/schedule`);
        const matchRef = ref(db, `tournaments/${eventId}/match`); // Init match state
        
        let matchIdCounter = 1;

        tournamentData.divisions.forEach(div => {
            const teams = div.teams;
            for (let i = 0; i < teams.length; i++) {
                for (let j = i + 1; j < teams.length; j++) {
                    const newMatch = {
                        id: matchIdCounter++,
                        division: div.name,
                        teamA: teams[i],
                        teamB: teams[j],
                        status: 'scheduled',
                        scoreA: 0,
                        scoreB: 0,
                        timeRemaining: tournamentData.settings.duration * 60,
                        sport: tournamentData.sport,
                        field: (matchIdCounter % tournamentData.settings.fields) + 1,
                        timeSlot: "10:00"
                    };
                    push(scheduleRef, newMatch);
                }
            }
        });

        // Initialize Live Match State (Empty)
        set(matchRef, {
            teamA: "TBD", teamB: "TBD", scoreA: 0, scoreB: 0, 
            time: 0, isRunning: false, sport: tournamentData.sport
        });

        changeStep(4);
    };
</script>
