<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | LaxChamp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .swap-target { border: 2px dashed #f59e0b; background: #fffbeb; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

    <div class="max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg></div>
                <h1 class="text-xl font-bold text-slate-800">Tournament Director</h1>
            </div>
            <a href="index.html" class="text-sm font-bold text-slate-500 hover:text-slate-800">Exit</a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT COLUMN: CONFIG (4 cols) -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- 1. SETUP -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                        <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs">1</span> Teams & Pitches
                    </h2>
                    
                    <textarea id="teamInput" class="w-full border rounded-lg p-3 text-sm h-32 mb-3 font-mono" placeholder="St Swithuns, U19A&#10;Wycombe Abbey, U19A&#10;Putney High, U19B"></textarea>
                    
                    <div class="flex gap-2 mb-3">
                        <input type="number" id="pitchCount" value="4" class="border rounded p-2 w-16 text-center text-sm" placeholder="Pitches">
                        <button onclick="importTeams()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-indigo-700">Import & Save</button>
                    </div>
                    
                    <div class="flex justify-between items-center text-xs text-slate-500 border-t pt-2">
                        <span id="teamCount">0 Teams</span>
                        <span id="pitchDisplay">4 Pitches</span>
                    </div>
                </div>

                <!-- 2. POOLING -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                        <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs">2</span> Pooling
                    </h2>
                    
                    <div class="mb-3">
                        <label class="text-xs font-bold text-slate-500 uppercase">Category</label>
                        <select id="poolCatSelect" class="w-full border rounded p-2 text-sm bg-white"></select>
                    </div>

                    <div class="flex gap-2 mb-3">
                        <select id="poolCount" class="w-1/3 border rounded p-2 text-sm">
                            <option value="1">1 Pool</option>
                            <option value="2">2 Pools</option>
                            <option value="3">3 Pools</option>
                            <option value="4">4 Pools</option>
                        </select>
                        <button onclick="assignPools()" class="flex-1 bg-slate-800 text-white py-2 rounded-lg font-bold text-sm hover:bg-slate-900">Shuffle into Pools</button>
                    </div>

                    <div id="poolPreview" class="text-xs text-slate-500 space-y-1 max-h-32 overflow-y-auto border p-2 rounded bg-slate-50">
                        No pools generated.
                    </div>
                </div>

                <!-- 3. SCHEDULER -->
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500">
                    <h2 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                        <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">3</span> Auto Scheduler
                    </h2>

                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="text-[0.65rem] font-bold text-slate-400 uppercase">Start Time</label>
                            <input type="time" id="startTime" value="09:00" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-[0.65rem] font-bold text-slate-400 uppercase">Game Mins</label>
                            <input type="number" id="gameDuration" value="15" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-[0.65rem] font-bold text-slate-400 uppercase">Gap Mins</label>
                            <input type="number" id="gapDuration" value="5" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-[0.65rem] font-bold text-slate-400 uppercase">Min Rest</label>
                            <input type="number" id="minRest" value="1" class="w-full border rounded p-2 text-sm" title="Matches to sit out">
                        </div>
                    </div>

                    <button onclick="generateSchedule()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-sm transition">Generate Schedule</button>
                </div>
                
                <button onclick="wipeData()" class="w-full text-center text-xs text-red-400 hover:text-red-600 underline">⚠️ Factory Reset</button>
            </div>

            <!-- RIGHT COLUMN: SCHEDULE (8 cols) -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[800px]">
                    
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <div>
                            <h2 class="font-bold text-slate-800">Master Schedule</h2>
                            <p class="text-xs text-slate-500" id="scheduleMeta">0 Matches Scheduled</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleEdit()" id="editBtn" class="bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded text-xs font-bold hover:bg-slate-50">Edit Mode</button>
                            <button onclick="window.print()" class="bg-slate-800 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-slate-700">Print</button>
                        </div>
                    </div>

                    <div class="overflow-auto flex-grow bg-slate-50 p-4">
                        <div id="scheduleGrid" class="space-y-2">
                            <!-- JS Renders Here -->
                            <div class="text-center text-slate-400 py-20">No matches scheduled yet.</div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        const params = new URLSearchParams(window.location.search);
        const eventID = params.get('event');
        if(!eventID) window.location.href = 'index.html';

        let teams = [], matches = [], pitches = 4;
        let editMode = false, swapSource = null;

        // SYNC
        onValue(ref(db, `lax/${eventID}`), (snap) => {
            const data = snap.val() || {};
            teams = data.teams || [];
            matches = data.matches || [];
            pitches = data.pitches || 4;
            
            document.getElementById('teamCount').innerText = `${teams.length} Teams`;
            document.getElementById('pitchDisplay').innerText = `${pitches} Pitches`;
            document.getElementById('pitchCount').value = pitches;
            document.getElementById('scheduleMeta').innerText = `${matches.length} Matches | ${pitches} Pitches`;
            
            updatePoolUI();
            renderSchedule();
        });

        // 1. IMPORT TEAMS
        window.importTeams = function() {
            const txt = document.getElementById('teamInput').value;
            const newTeams = [];
            txt.split('\n').forEach(l => {
                const p = l.split(',');
                if(p.length >= 2) newTeams.push({ 
                    id: crypto.randomUUID(), 
                    name: p[0].trim(), 
                    cat: p[1].trim().toUpperCase(),
                    pool: 'A' // Default pool
                });
            });
            set(ref(db, `lax/${eventID}/teams`), [...teams, ...newTeams]);
            set(ref(db, `lax/${eventID}/pitches`), parseInt(document.getElementById('pitchCount').value));
            document.getElementById('teamInput').value = '';
        };

        // 2. POOLING
        function updatePoolUI() {
            const cats = [...new Set(teams.map(t => t.cat))];
            const sel = document.getElementById('poolCatSelect');
            if(sel.options.length !== cats.length) {
                sel.innerHTML = '';
                cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
            }
            
            // Preview
            const preview = document.getElementById('poolPreview');
            preview.innerHTML = '';
            cats.forEach(c => {
                const ct = teams.filter(t => t.cat === c);
                // Group by pool
                const pools = {};
                ct.forEach(t => {
                    if(!pools[t.pool]) pools[t.pool] = [];
                    pools[t.pool].push(t.name);
                });
                
                let html = `<strong>${c}:</strong> `;
                for(let p in pools) html += `[${p}: ${pools[p].length}] `;
                preview.innerHTML += `<div class="mb-1">${html}</div>`;
            });
        }

        window.assignPools = function() {
            const cat = document.getElementById('poolCatSelect').value;
            const count = parseInt(document.getElementById('poolCount').value);
            const poolNames = ['A','B','C','D','E','F'];
            
            let catTeams = teams.filter(t => t.cat === cat);
            let otherTeams = teams.filter(t => t.cat !== cat);
            
            // Shuffle
            catTeams.sort(() => Math.random() - 0.5);
            
            // Distribute
            catTeams.forEach((t, i) => {
                t.pool = poolNames[i % count];
            });

            set(ref(db, `lax/${eventID}/teams`), [...otherTeams, ...catTeams]);
        };

        // 3. SCHEDULER (The Brain)
        window.generateSchedule = function() {
            const duration = parseInt(document.getElementById('gameDuration').value);
            const gap = parseInt(document.getElementById('gapDuration').value);
            const minRest = parseInt(document.getElementById('minRest').value);
            const startStr = document.getElementById('startTime').value;
            const [sh, sm] = startStr.split(':').map(Number);
            let startTime = sh * 60 + sm;

            // Generate Fixtures for ALL categories based on pools
            let fixtures = [];
            const cats = [...new Set(teams.map(t => t.cat))];
            
            cats.forEach(cat => {
                const catTeams = teams.filter(t => t.cat === cat);
                const pools = [...new Set(catTeams.map(t => t.pool))];
                
                pools.forEach(p => {
                    const poolTeams = catTeams.filter(t => t.pool === p);
                    // Round Robin Logic
                    for(let i=0; i<poolTeams.length; i++) {
                        for(let j=i+1; j<poolTeams.length; j++) {
                            fixtures.push({
                                id: crypto.randomUUID(),
                                cat: cat,
                                pool: p,
                                teamA: poolTeams[i].name,
                                teamB: poolTeams[j].name,
                                scoreA: 0,
                                scoreB: 0,
                                status: 'scheduled'
                            });
                        }
                    }
                });
            });

            // Scheduling Algorithm (Greedy with Constraints)
            let schedule = [];
            let timePointer = startTime;
            let pitchPointer = 1;
            let teamLastPlayed = {}; // Map teamName -> time they finish

            // Optimization: Shuffle fixtures to mix categories
            fixtures.sort(() => Math.random() - 0.5);

            while(fixtures.length > 0) {
                let slotMatches = [];
                let roundTeams = new Set(); // Teams playing in this specific time slot
                let availablePitches = pitches;

                // Try to fill pitches for this time slot
                for(let i = fixtures.length - 1; i >= 0; i--) {
                    if(availablePitches <= 0) break;
                    
                    let f = fixtures[i];
                    
                    // Constraint 1: Team not already playing this slot
                    if(roundTeams.has(f.teamA) || roundTeams.has(f.teamB)) continue;

                    // Constraint 2: Rest Period (Check if last game finished too recently)
                    let finishA = teamLastPlayed[f.teamA] || 0;
                    let finishB = teamLastPlayed[f.teamB] || 0;
                    let restTime = (duration + gap) * minRest; // e.g. 20 mins * 1
                    
                    if (timePointer < finishA + restTime || timePointer < finishB + restTime) continue;

                    // Success - Schedule it
                    f.time = formatTime(timePointer);
                    f.pitch = (pitches - availablePitches) + 1;
                    
                    slotMatches.push(f);
                    roundTeams.add(f.teamA);
                    roundTeams.add(f.teamB);
                    
                    // Update finish times
                    teamLastPlayed[f.teamA] = timePointer + duration;
                    teamLastPlayed[f.teamB] = timePointer + duration;
                    
                    availablePitches--;
                    fixtures.splice(i, 1);
                }

                if(slotMatches.length === 0) {
                    // Force time forward if we can't fit anyone (e.g. everyone resting)
                    timePointer += duration + gap;
                } else {
                    schedule.push(...slotMatches);
                    // Only advance time if we filled pitches or ran out of valid games
                    if(availablePitches === 0 || fixtures.length > 0) {
                         timePointer += duration + gap;
                    }
                }
                
                // Safety break
                if(timePointer > 22*60) break; 
            }

            set(ref(db, `lax/${eventID}/matches`), schedule);
            alert(`Generated ${schedule.length} matches.`);
        };

        // 4. MANUAL EDITS
        window.toggleEdit = function() {
            editMode = !editMode;
            document.getElementById('editBtn').className = editMode ? "bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold" : "bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded text-xs font-bold";
            renderSchedule();
        };

        window.handleMatchClick = function(idx) {
            if(!editMode) return;

            if(swapSource === null) {
                swapSource = idx;
                renderSchedule(); // Redraw to show highlight
            } else {
                // Swap logic
                const temp = matches[swapSource];
                matches[swapSource] = matches[idx];
                matches[idx] = temp;
                
                // Swap times/pitches to maintain grid structure? 
                // Actually, usually we want to swap the TEAMS but keep the Time/Pitch.
                // Let's swap the whole object for now, but update the Time/Pitch to match the slot.
                const t1 = matches[swapSource].time;
                const p1 = matches[swapSource].pitch;
                
                matches[swapSource].time = matches[idx].time;
                matches[swapSource].pitch = matches[idx].pitch;
                
                matches[idx].time = t1;
                matches[idx].pitch = p1;

                set(ref(db, `lax/${eventID}/matches`), matches);
                swapSource = null;
            }
        };

        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            
            // Sort
            matches.sort((a,b) => a.time.localeCompare(b.time) || a.pitch - b.pitch);

            if(matches.length === 0) {
                grid.innerHTML = '<div class="text-center text-slate-400 py-10">No matches scheduled.</div>';
                return;
            }

            // Group by Time for cleaner layout
            let currentGroup = '';
            
            matches.forEach((m, i) => {
                let border = "";
                if(swapSource === i) border = "border-2 border-blue-500 bg-blue-50";
                
                let cursor = editMode ? "cursor-pointer hover:border-blue-300" : "";
                
                // Header for time change
                if(m.time !== currentGroup) {
                    grid.innerHTML += `<div class="mt-4 mb-2 text-xs font-bold text-slate-400 uppercase tracking-widest pl-2 sticky top-0 bg-slate-50 z-10">${m.time}</div>`;
                    currentGroup = m.time;
                }

                grid.innerHTML += `
                <div onclick="handleMatchClick(${matches.indexOf(m)})" class="bg-white p-3 rounded-lg border border-slate-200 flex items-center justify-between shadow-sm ${border} ${cursor}">
                    <div class="flex items-center gap-3 w-32">
                        <div class="font-mono text-sm font-bold text-slate-700">${m.time}</div>
                        <div class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded font-bold">P${m.pitch}</div>
                    </div>
                    
                    <div class="flex-1 flex justify-center items-center gap-4">
                        <span class="text-sm font-bold text-right w-1/3 truncate">${m.teamA}</span>
                        <span class="text-xs text-slate-300 font-bold">VS</span>
                        <span class="text-sm font-bold text-left w-1/3 truncate">${m.teamB}</span>
                    </div>

                    <div class="w-32 flex justify-end items-center gap-2">
                        <span class="text-[0.65rem] uppercase font-bold text-indigo-400 border border-indigo-100 px-1.5 py-0.5 rounded">${m.cat} ${m.pool}</span>
                        ${m.status === 'finished' ? `<span class="bg-slate-800 text-white text-xs font-bold px-2 py-1 rounded">${m.scoreA}-${m.scoreB}</span>` : ''}
                        ${m.status === 'active' ? `<span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded animate-pulse">LIVE</span>` : ''}
                    </div>
                </div>`;
            });
        }

        function formatTime(minutes) {
            let h = Math.floor(minutes / 60);
            let m = minutes % 60;
            if(h>=24) h-=24;
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        }
        
        window.wipeData = () => { if(confirm("DELETE EVERYTHING?")) set(ref(db, `lax/${eventID}`), null); };
    </script>
</body>
</html>
