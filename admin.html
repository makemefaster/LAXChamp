<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | LaxChamp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

    <div class="max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg></div>
                <h1 class="text-xl font-bold text-slate-800">Tournament Director</h1>
            </div>
            <a href="index.html" class="text-sm font-bold text-slate-500 hover:text-slate-800">Exit</a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT COLUMN: TOOLS (4 cols) -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- TABS -->
                <div class="flex bg-white rounded-lg p-1 border border-slate-200">
                    <button onclick="showTab('setup')" id="btn-setup" class="flex-1 py-2 text-xs font-bold rounded bg-slate-100 text-slate-800">Setup</button>
                    <button onclick="showTab('standings')" id="btn-standings" class="flex-1 py-2 text-xs font-bold rounded text-slate-500 hover:bg-slate-50">Standings</button>
                </div>

                <!-- TAB: SETUP -->
                <div id="tab-setup" class="space-y-6">
                    <!-- Teams -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="font-bold text-slate-800 mb-2">Teams & Pitches</h2>
                        <textarea id="teamInput" class="w-full border rounded-lg p-3 text-xs h-24 mb-3 font-mono" placeholder="St Swithuns, U19A&#10;Wycombe Abbey, U19A"></textarea>
                        <div class="flex gap-2">
                            <input type="number" id="pitchCount" value="4" class="border rounded p-2 w-16 text-center text-sm" placeholder="Pitches">
                            <button onclick="importTeams()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold text-xs hover:bg-indigo-700">Import</button>
                        </div>
                    </div>

                    <!-- Scheduler -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500">
                        <h2 class="font-bold text-slate-800 mb-2">Auto Scheduler</h2>
                        <div class="space-y-2 mb-3">
                            <select id="catSelect" class="w-full border rounded p-2 text-xs bg-white"></select>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="time" id="startTime" value="09:00" class="border rounded p-2 text-xs">
                                <input type="number" id="gameDuration" value="15" class="border rounded p-2 text-xs" placeholder="Mins">
                            </div>
                        </div>
                        <button onclick="generateSchedule()" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold text-xs hover:bg-green-700">Generate Round Robin</button>
                    </div>

                    <!-- Manual Match -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <h2 class="font-bold text-slate-800 mb-2">Add Single Match</h2>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input id="newTeamA" placeholder="Team A" class="border rounded p-2 text-xs">
                            <input id="newTeamB" placeholder="Team B" class="border rounded p-2 text-xs">
                            <input id="newTime" type="time" class="border rounded p-2 text-xs">
                            <input id="newPitch" type="number" placeholder="Pitch" class="border rounded p-2 text-xs">
                            <input id="newCat" placeholder="Cat/Name" class="col-span-2 border rounded p-2 text-xs">
                        </div>
                        <button onclick="addManualMatch()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-xs hover:bg-blue-700">+ Add Match</button>
                    </div>
                </div>

                <!-- TAB: STANDINGS (Live view for Admin) -->
                <div id="tab-standings" class="hidden bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-800 mb-2">Live Standings</h2>
                    <select id="standingsCat" class="w-full border rounded p-2 text-xs mb-3" onchange="renderAdminStandings()"></select>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-50 uppercase text-slate-500">
                                <tr><th>Team</th><th class="text-center">P</th><th class="text-center">Pts</th></tr>
                            </thead>
                            <tbody id="adminStandingsBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <button onclick="wipeData()" class="w-full text-center text-xs text-red-400 hover:text-red-600 underline mt-4">‚ö†Ô∏è Factory Reset</button>
            </div>

            <!-- RIGHT COLUMN: SCHEDULE (8 cols) -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[800px]">
                    
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center sticky top-0 z-10">
                        <div>
                            <h2 class="font-bold text-slate-800">Master Schedule</h2>
                            <p class="text-xs text-slate-500" id="scheduleMeta">0 Matches</p>
                        </div>
                        <button onclick="window.print()" class="bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded text-xs font-bold hover:bg-slate-50">Print</button>
                    </div>

                    <div class="overflow-auto flex-grow bg-slate-50 p-4">
                        <div id="scheduleGrid" class="space-y-2"></div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- EDIT MATCH MODAL -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Edit Match Result</h3>
            <input type="hidden" id="editIndex">
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs font-bold text-slate-500">Home Score</label>
                    <input type="number" id="editScoreA" class="w-full border-2 border-slate-200 rounded p-2 text-xl font-bold text-center">
                    <div id="editTeamA" class="text-xs text-center mt-1 font-bold"></div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">Away Score</label>
                    <input type="number" id="editScoreB" class="w-full border-2 border-slate-200 rounded p-2 text-xl font-bold text-center">
                    <div id="editTeamB" class="text-xs text-center mt-1 font-bold"></div>
                </div>
            </div>

            <div class="mb-4">
                <label class="text-xs font-bold text-slate-500">Status</label>
                <select id="editStatus" class="w-full border rounded p-2">
                    <option value="scheduled">Scheduled</option>
                    <option value="active">Active (Live)</option>
                    <option value="finished">Finished</option>
                </select>
            </div>

            <div class="flex gap-2">
                <button onclick="saveMatchEdit()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Save</button>
                <button onclick="closeEditModal()" class="flex-1 bg-slate-200 text-slate-600 py-2 rounded font-bold hover:bg-slate-300">Cancel</button>
                <button onclick="deleteMatch()" class="px-3 bg-red-100 text-red-600 rounded font-bold hover:bg-red-200">üóë</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        const params = new URLSearchParams(window.location.search);
        const eventID = params.get('event');
        if(!eventID) window.location.href = 'index.html';

        let teams = [], matches = [], pitches = 4;

        // SYNC
        onValue(ref(db, `lax/${eventID}`), (snap) => {
            const data = snap.val() || {};
            teams = data.teams || [];
            matches = data.matches || [];
            pitches = data.pitches || 4;
            
            document.getElementById('scheduleMeta').innerText = `${matches.length} Matches | ${pitches} Pitches`;
            
            updateCatSelect();
            renderSchedule();
            renderAdminStandings(); // Update standings in real-time
        });

        // 1. IMPORT
        window.importTeams = function() {
            const txt = document.getElementById('teamInput').value;
            const newTeams = [];
            txt.split('\n').forEach(l => {
                const p = l.split(',');
                if(p.length >= 2) newTeams.push({ name: p[0].trim(), cat: p[1].trim().toUpperCase() });
            });
            set(ref(db, `lax/${eventID}/teams`), [...teams, ...newTeams]);
            set(ref(db, `lax/${eventID}/pitches`), parseInt(document.getElementById('pitchCount').value));
        };

        // 2. AUTO SCHEDULER
        window.generateSchedule = function() {
            const cat = document.getElementById('catSelect').value;
            const duration = parseInt(document.getElementById('gameDuration').value);
            let startInput = document.getElementById('startTime').value;
            const catTeams = teams.filter(t => t.cat === cat);
            
            if(catTeams.length < 2) return alert("Need teams");

            let pendingMatches = [];
            for(let i=0; i<catTeams.length; i++) {
                for(let j=i+1; j<catTeams.length; j++) {
                    pendingMatches.push({ cat, teamA: catTeams[i].name, teamB: catTeams[j].name, scoreA: 0, scoreB: 0, status: 'scheduled' });
                }
            }
            pendingMatches.sort(() => Math.random() - 0.5);

            let [h, m] = startInput.split(':').map(Number);
            let timeMins = h * 60 + m;
            let newSchedule = [];

            while(pendingMatches.length > 0) {
                let slot = [];
                let busy = new Set();
                let availPitches = pitches;
                
                for(let i=pendingMatches.length-1; i>=0; i--) {
                    if(availPitches<=0) break;
                    let m = pendingMatches[i];
                    if(!busy.has(m.teamA) && !busy.has(m.teamB)) {
                        m.time = formatTime(timeMins);
                        m.pitch = (pitches - availPitches) + 1;
                        slot.push(m);
                        busy.add(m.teamA); busy.add(m.teamB);
                        availPitches--;
                        pendingMatches.splice(i, 1);
                    }
                }
                newSchedule.push(...slot);
                if(slot.length > 0) timeMins += duration + 5;
            }
            set(ref(db, `lax/${eventID}/matches`), [...matches, ...newSchedule]);
        };

        // 3. MANUAL MATCH
        window.addManualMatch = function() {
            const m = {
                teamA: document.getElementById('newTeamA').value,
                teamB: document.getElementById('newTeamB').value,
                cat: document.getElementById('newCat').value,
                time: document.getElementById('newTime').value,
                pitch: parseInt(document.getElementById('newPitch').value),
                scoreA: 0, scoreB: 0, status: 'scheduled'
            };
            if(!m.teamA || !m.teamB) return alert("Enter Teams");
            set(ref(db, `lax/${eventID}/matches`), [...matches, m]);
        };

        // 4. EDIT LOGIC
        window.openEditModal = function(idx) {
            const m = matches[idx];
            document.getElementById('editIndex').value = idx;
            document.getElementById('editTeamA').innerText = m.teamA;
            document.getElementById('editTeamB').innerText = m.teamB;
            document.getElementById('editScoreA').value = m.scoreA;
            document.getElementById('editScoreB').value = m.scoreB;
            document.getElementById('editStatus').value = m.status;
            document.getElementById('editModal').classList.remove('hidden');
        };

        window.saveMatchEdit = function() {
            const idx = document.getElementById('editIndex').value;
            const updates = {};
            updates[`lax/${eventID}/matches/${idx}/scoreA`] = parseInt(document.getElementById('editScoreA').value);
            updates[`lax/${eventID}/matches/${idx}/scoreB`] = parseInt(document.getElementById('editScoreB').value);
            updates[`lax/${eventID}/matches/${idx}/status`] = document.getElementById('editStatus').value;
            update(ref(db), updates);
            closeEditModal();
        };

        window.deleteMatch = function() {
            if(!confirm("Delete this match?")) return;
            const idx = document.getElementById('editIndex').value;
            matches.splice(idx, 1);
            set(ref(db, `lax/${eventID}/matches`), matches);
            closeEditModal();
        };

        window.closeEditModal = () => document.getElementById('editModal').classList.add('hidden');

        // UI HELPERS
        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            matches.sort((a,b) => a.time.localeCompare(b.time) || a.pitch - b.pitch);

            let lastTime = '';
            matches.forEach((m, i) => {
                if(m.time !== lastTime) {
                    grid.innerHTML += `<div class="mt-4 mb-2 text-xs font-bold text-slate-400 pl-2 bg-slate-50 sticky top-0">${m.time}</div>`;
                    lastTime = m.time;
                }
                
                // Color code status
                let border = "border-slate-200";
                if(m.status === 'active') border = "border-green-500 bg-green-50";
                if(m.status === 'finished') border = "border-slate-300 bg-slate-100 opacity-75";

                grid.innerHTML += `
                <div onclick="openEditModal(${matches.indexOf(m)})" class="p-3 rounded-lg border ${border} bg-white flex items-center justify-between shadow-sm cursor-pointer hover:shadow-md transition">
                    <div class="flex items-center gap-2 w-24">
                        <div class="text-xs bg-slate-200 text-slate-600 px-1.5 rounded font-bold">P${m.pitch}</div>
                        <div class="text-[0.65rem] font-bold text-indigo-500 uppercase truncate">${m.cat}</div>
                    </div>
                    <div class="flex-1 flex justify-center items-center gap-2 text-sm">
                        <span class="font-bold text-right w-1/3 truncate">${m.teamA}</span>
                        <span class="text-xs text-slate-400">v</span>
                        <span class="font-bold text-left w-1/3 truncate">${m.teamB}</span>
                    </div>
                    <div class="w-16 text-right font-mono font-bold text-slate-700">${m.scoreA} - ${m.scoreB}</div>
                </div>`;
            });
        }

        // STANDINGS LOGIC (Replicated from Live)
        window.renderAdminStandings = function() {
            const cat = document.getElementById('standingsCat').value || document.getElementById('catSelect').value;
            const tb = document.getElementById('adminStandingsBody');
            tb.innerHTML = '';

            let stats = {};
            matches.filter(m => m.cat === cat && m.status === 'finished').forEach(m => {
                if(!stats[m.teamA]) stats[m.teamA] = {p:0, pts:0, gd:0};
                if(!stats[m.teamB]) stats[m.teamB] = {p:0, pts:0, gd:0};
                
                stats[m.teamA].p++; stats[m.teamB].p++;
                let gd = m.scoreA - m.scoreB;
                stats[m.teamA].gd += gd; stats[m.teamB].gd -= gd;

                if(m.scoreA > m.scoreB) stats[m.teamA].pts += 5; // Win=5
                else if(m.scoreB > m.scoreA) stats[m.teamB].pts += 5;
                else { stats[m.teamA].pts += 3; stats[m.teamB].pts += 3; } // Draw=3
            });

            Object.keys(stats).sort((a,b) => stats[b].pts - stats[a].pts).forEach(t => {
                tb.innerHTML += `<tr class="border-b"><td class="py-1">${t}</td><td class="text-center">${stats[t].p}</td><td class="text-center font-bold">${stats[t].pts}</td></tr>`;
            });
        };

        function updateCatSelect() {
            const cats = [...new Set(teams.map(t => t.cat))].sort();
            const s1 = document.getElementById('catSelect');
            const s2 = document.getElementById('standingsCat');
            [s1, s2].forEach(sel => {
                const current = sel.value;
                sel.innerHTML = '';
                cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
                if(cats.includes(current)) sel.value = current;
            });
        }

        function formatTime(m) { let h=Math.floor(m/60), mm=m%60; if(h>=24) h-=24; return `${h.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}`; }
        window.showTab = (t) => {
            document.getElementById('tab-setup').classList.add('hidden');
            document.getElementById('tab-standings').classList.add('hidden');
            document.getElementById('btn-setup').className = "flex-1 py-2 text-xs font-bold rounded text-slate-500 hover:bg-slate-50";
            document.getElementById('btn-standings').className = "flex-1 py-2 text-xs font-bold rounded text-slate-500 hover:bg-slate-50";
            
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.getElementById(`btn-${t}`).className = "flex-1 py-2 text-xs font-bold rounded bg-slate-100 text-slate-800";
        };
        window.wipeData = () => { if(confirm("DELETE EVERYTHING?")) set(ref(db, `lax/${eventID}`), null); };
    </script>
</body>
</html>
