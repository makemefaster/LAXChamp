<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Champ - Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: system-ui, sans-serif; }</style>
</head>
<body class="bg-gray-50 text-gray-800 pb-10">

    <div class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <button onclick="goBack()" class="text-sm text-gray-400">‚Üê Back</button>
        <h1 class="font-bold text-lg uppercase tracking-wider">Schedule</h1>
        <div class="w-8"></div>
    </div>

    <div class="p-4 bg-white border-b flex gap-2 overflow-x-auto">
        <select id="filterDiv" onchange="renderSchedule()" class="p-2 border rounded bg-gray-50 flex-1">
            <option value="all">All Divisions</option>
        </select>
        <select id="filterField" onchange="renderSchedule()" class="p-2 border rounded bg-gray-50 flex-1">
            <option value="all">All Fields</option>
        </select>
    </div>

    <div id="matchList" class="max-w-2xl mx-auto">
        <div class="text-center p-8 text-gray-400">Loading schedule...</div>
    </div>

    <script type="module">
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
        import { app } from './firebase-config.js';

        const db = getDatabase(app);
        
        // 1. Get Event ID
        const params = new URLSearchParams(window.location.search);
        const eventId = params.get('event');
        
        if(!eventId) {
            document.getElementById('matchList').innerHTML = '<div class="text-center p-8 text-red-500">Error: No Event ID found.</div>';
        } else {
            const scheduleRef = ref(db, `tournaments/${eventId}/schedule`);
            
            let allMatches = [];
            let divisions = new Set();
            let fields = new Set();

            onValue(scheduleRef, (snapshot) => {
                const container = document.getElementById('matchList');
                container.innerHTML = '';
                allMatches = [];
                divisions.clear();
                fields.clear();

                if(!snapshot.exists()) {
                    container.innerHTML = '<div class="text-center p-8 text-gray-400">No matches scheduled yet.</div>';
                    return;
                }

                snapshot.forEach(child => {
                    const m = child.val();
                    allMatches.push(m);
                    if(m.division) divisions.add(m.division);
                    if(m.field) fields.add(m.field);
                });

                populateSelect('filterDiv', divisions);
                populateSelect('filterField', fields);
                renderSchedule();
            });

            // Helper to populate dropdowns
            function populateSelect(id, set) {
                const el = document.getElementById(id);
                const current = el.value;
                while(el.options.length > 1) { el.remove(1); }
                set.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item;
                    opt.innerText = isNaN(item) ? item : `Field ${item}`;
                    el.appendChild(opt);
                });
                if([...set].includes(current)) el.value = current;
            }

            // Render List
            window.renderSchedule = () => {
                const filterDiv = document.getElementById('filterDiv').value;
                const filterField = document.getElementById('filterField').value;
                const container = document.getElementById('matchList');
                container.innerHTML = '';

                const sorted = allMatches.sort((a,b) => (a.timeSlot || '').localeCompare(b.timeSlot || ''));

                sorted.forEach(m => {
                    if(filterDiv !== 'all' && m.division !== filterDiv) return;
                    if(filterField !== 'all' && m.field != filterField) return;

                    const div = document.createElement('div');
                    div.className = 'bg-white p-4 border-b flex items-center justify-between';
                    div.innerHTML = `
                        <div class="text-xs text-gray-500 w-16">
                            <div class="font-bold text-gray-700 text-sm">${m.timeSlot || '--:--'}</div>
                            <div>Field ${m.field || '?'}</div>
                        </div>
                        <div class="flex-1 px-4 font-semibold text-gray-800">
                            ${m.teamA} <span class="text-gray-400 text-xs mx-1">VS</span> ${m.teamB}
                            <div class="text-xs text-blue-600 font-normal">${m.division}</div>
                        </div>
                        <div>
                            ${m.status === 'finished' 
                                ? `<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">${m.scoreA}-${m.scoreB}</span>` 
                                : '<span class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded">Upcoming</span>'}
                        </div>
                    `;
                    container.appendChild(div);
                });
            };
        }

        window.goBack = () => {
            window.location.href = `index.html?event=${eventId}`;
        };
    </script>
</body>
</html>
